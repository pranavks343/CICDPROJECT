---
# Kubernetes installation and configuration
- name: Add Kubernetes GPG key
  apt_key:
    url: https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key
    state: present

- name: Add Kubernetes repository
  apt_repository:
    repo: "deb https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /"
    state: present
    filename: kubernetes

- name: Install Kubernetes packages
  apt:
    name:
      - kubelet
      - kubeadm
      - kubectl
    state: present
    update_cache: yes

- name: Hold Kubernetes packages
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop:
    - kubelet
    - kubeadm
    - kubectl

- name: Configure containerd
  block:
    - name: Create containerd config directory
      file:
        path: /etc/containerd
        state: directory
    
    - name: Generate containerd config
      shell: containerd config default > /etc/containerd/config.toml
      args:
        creates: /etc/containerd/config.toml
    
    - name: Enable SystemdCgroup in containerd
      lineinfile:
        path: /etc/containerd/config.toml
        regexp: '^\s*SystemdCgroup\s*='
        line: '            SystemdCgroup = true'
        insertafter: '^\s*\[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options\]'
      notify: restart containerd

- name: Start and enable containerd
  systemd:
    name: containerd
    state: started
    enabled: yes

- name: Start and enable kubelet
  systemd:
    name: kubelet
    state: started
    enabled: yes

# Master node specific tasks
- name: Initialize Kubernetes master
  block:
    - name: Check if cluster is already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: k8s_admin_conf
    
    - name: Initialize Kubernetes cluster
      command: >
        kubeadm init
        --pod-network-cidr=10.244.0.0/16
        --apiserver-advertise-address={{ ansible_host }}
      when: not k8s_admin_conf.stat.exists
      register: kubeadm_init
    
    - name: Create .kube directory
      file:
        path: "{{ ansible_env.HOME }}/.kube"
        state: directory
        mode: '0755'
    
    - name: Copy admin.conf to user's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "{{ ansible_env.HOME }}/.kube/config"
        remote_src: yes
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
    
    - name: Install Calico CNI
      command: kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
      when: not k8s_admin_conf.stat.exists
    
    - name: Generate join command
      command: kubeadm token create --print-join-command
      register: join_command
    
    - name: Save join command to file
      copy:
        content: "{{ join_command.stdout }}"
        dest: /tmp/k8s-join-command
  when: node_role == "master"

# Worker node specific tasks
- name: Join worker nodes to cluster
  block:
    - name: Check if node is already joined
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf
    
    - name: Copy join command from master
      fetch:
        src: /tmp/k8s-join-command
        dest: /tmp/k8s-join-command
        flat: yes
      delegate_to: "{{ groups['master'][0] }}"
      when: not kubelet_conf.stat.exists
    
    - name: Join the cluster
      command: "{{ lookup('file', '/tmp/k8s-join-command') }}"
      when: not kubelet_conf.stat.exists
  when: node_role == "worker"

# Install Helm
- name: Install Helm
  block:
    - name: Download Helm installation script
      get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get_helm.sh
        mode: '0700'
    
    - name: Install Helm
      command: /tmp/get_helm.sh
      args:
        creates: /usr/local/bin/helm
  when: node_role == "master"

# Install kubectl plugins
- name: Install kubectl plugins
  block:
    - name: Install krew (kubectl plugin manager)
      shell: |
        set -x
        cd "$(mktemp -d)"
        OS="$(uname | tr '[:upper:]' '[:lower:]')"
        ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/')"
        KREW="krew-${OS}_${ARCH}"
        curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz"
        tar zxvf "${KREW}.tar.gz"
        ./"${KREW}" install krew
      args:
        creates: "{{ ansible_env.HOME }}/.krew"
  when: node_role == "master"

